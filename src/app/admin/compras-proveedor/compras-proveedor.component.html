<div class="compras-container">
  <!-- Header de página -->
  <div class="page-header">
    <h2>
      Registrar Compra a Proveedor
    </h2>
  </div>

  <!-- Indicador de carga -->
  <div *ngIf="cargando" class="loading-container">
    <i class="fas fa-spinner fa-spin"></i>
    Cargando datos...
  </div>

  <!-- Sección: Selección de Proveedor -->
  <div class="content-card">
    <div class="card-header">
      <h3>
        <i class="fas fa-building"></i>
        Selección de Proveedor
      </h3>
    </div>
    <div class="card-content">
      <div class="input-icon">
        <i class="fas fa-building"></i>
        <select
          [(ngModel)]="proveedorId"
          (ngModelChange)="onProveedorChange()"
          [disabled]="cargando"
        >
          <option [ngValue]="null">-- Selecciona un proveedor --</option>
          <option *ngFor="let p of proveedores" [ngValue]="p.id">{{ p.nombre }}</option>
        </select>
      </div>

      <div *ngIf="!proveedorId" class="info-message">
        <i class="fas fa-info-circle"></i>
        Primero debe seleccionar un proveedor para ver sus productos disponibles
      </div>

      <div *ngIf="proveedorId && productosDelProveedor.length === 0 && !cargando" class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        Este proveedor no tiene productos asignados. Debe asignar productos al proveedor primero.
      </div>
    </div>
  </div>

  <!-- Sección: Productos a Comprar -->
  <div *ngIf="proveedorId && productosDelProveedor.length > 0" class="content-card">
    <div class="card-header">
      <h3>
        <i class="fas fa-box"></i>
        Productos a Comprar
        <span class="count-badge">{{ detalles.length }}</span>
      </h3>
    </div>
    <div class="card-content">
      <div class="productos-grid">
        <div *ngFor="let detalle of detalles; let i = index" class="producto-item">
          <div class="producto-row">
            <div class="form-group producto-select">
              <label>Producto</label>
              <div class="input-icon">
                <i class="fas fa-box"></i>
                <select
                  [(ngModel)]="detalle.productoId"
                  (ngModelChange)="onProductoChange(detalle)"
                  [disabled]="cargando"
                >
                  <option [ngValue]="0">-- Selecciona producto --</option>
                  <option *ngFor="let p of productosDelProveedor" [ngValue]="p.productoId">
                    {{ p.productoNombre }}
                    <span *ngIf="p.precioProveedor">({{ p.precioProveedor | currency }})</span>
                  </option>
                </select>
              </div>
            </div>

            <div class="form-group cantidad-input">
              <label>Cantidad</label>
              <div class="input-icon">
                <i class="fas fa-sort-numeric-up"></i>
                <input
                  type="number"
                  min="1"
                  [(ngModel)]="detalle.cantidad"
                  (ngModelChange)="onCantidadChange(detalle)"
                  [disabled]="cargando"
                  placeholder="0"
                />
              </div>
            </div>

            <div class="form-group subtotal-group">
              <label>Subtotal</label>
              <div class="subtotal-display">
                <span *ngIf="detalle.productoId > 0 && detalle.cantidad > 0" class="subtotal-amount">
                  {{ calcularSubtotal(detalle) | currency }}
                </span>
                <span *ngIf="detalle.productoId <= 0 || detalle.cantidad <= 0" class="subtotal-placeholder">
                  $0.00
                </span>
              </div>
            </div>

            <div class="form-group actions-group">
              <label>&nbsp;</label>
              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-danger"
                  (click)="eliminarDetalle(i)"
                  *ngIf="detalles.length > 1"
                  [disabled]="cargando"
                  title="Eliminar producto"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="acciones-productos">
        <button
          type="button"
          class="btn-secundario btn-small"
          (click)="agregarDetalle()"
          [disabled]="cargando"
        >
          <i class="fas fa-plus"></i>
          Agregar Producto
        </button>
      </div>

      <!-- Total de la compra -->
      <div class="total-compra" *ngIf="calcularTotal() > 0">
        <div class="total-label">Total de la compra:</div>
        <div class="total-amount">{{ calcularTotal() | currency }}</div>
      </div>
    </div>
  </div>

  <!-- Sección: Información Adicional -->
  <div *ngIf="proveedorId && productosDelProveedor.length > 0" class="content-card">
    <div class="card-header">
      <h3>
        <i class="fas fa-sticky-note"></i>
        Información Adicional
      </h3>
    </div>
    <div class="card-content">
      <div class="form-group">
        <label for="notas">Notas de la compra</label>
        <div class="textarea-container">
          <i class="fas fa-comment textarea-icon"></i>
          <textarea
            id="notas"
            [(ngModel)]="notas"
            placeholder="Observaciones, número de factura, condiciones especiales..."
            rows="4"
            [disabled]="cargando"
            class="textarea-styled"
          ></textarea>
        </div>
      </div>

      <div class="form-actions-final">
        <button
          type="button"
          class="btn-secundario"
          (click)="abrirHistorial()"
          [disabled]="cargando"
        >
          <i class="fas fa-history"></i>
          Ver Historial
        </button>

        <button
          type="button"
          class="btn-primario"
          (click)="registrarCompra()"
          [disabled]="!puedeRegistrarCompra()"
        >
          <i class="fas fa-{{ cargando ? 'spinner fa-spin' : 'save' }}"></i>
          {{ cargando ? 'Registrando...' : 'Registrar Compra' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Sin productos disponibles -->
  <div *ngIf="proveedorId && productosDelProveedor.length === 0 && !cargando" class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-box-open"></i>
    </div>
    <h3>No hay productos disponibles</h3>
    <p>Este proveedor no tiene productos asignados. Debe asignar productos al proveedor antes de poder registrar compras.</p>
  </div>
</div>

<!-- Modal de Historial -->
<div *ngIf="mostrarHistorial" class="modal-overlay">
  <div class="modal-historial">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <i class="fas fa-history"></i>
          Historial de Compras
        </h3>
        <button
          type="button"
          class="btn-close"
          (click)="cerrarHistorial()"
          [disabled]="cargando"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Componente de búsqueda y filtro para historial -->
        <app-table-search-filter
          [config]="searchFilterConfig"
          [totalItems]="historialCompras.length"
          [filteredItems]="historialFiltrado.length"
          [loading]="cargando"
          (searchChange)="onSearchFilterChange($event)"
          (clearFilters)="onClearFilters()"
        ></app-table-search-filter>

        <div *ngIf="cargando" class="loading-container">
          <i class="fas fa-spinner fa-spin"></i>
          Cargando historial...
        </div>

        <div *ngIf="!cargando" class="tabla-container">
          <table class="tabla-moderna">
            <thead>
              <tr>
                <th>Proveedor</th>
                <th>Fecha</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let compra of historialFiltrado">
                <td>{{ compra.proveedorNombre }}</td>
                <td>
                  <div class="fecha-info">
                    <span class="fecha">{{ compra.fecha | date:'dd/MM/yyyy' }}</span>
                    <span class="hora">{{ compra.fecha | date:'HH:mm' }}</span>
                  </div>
                </td>
                <td>{{ compra.productoNombre }}</td>
                <td>
                  <span class="cantidad-badge">{{ compra.cantidad }}</span>
                </td>
                <td>
                  <span class="total-amount" *ngIf="compra.total">
                    {{ compra.total | currency }}
                  </span>
                  <span class="text-muted" *ngIf="!compra.total">N/A</span>
                </td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="historialFiltrado.length === 0 && historialCompras.length > 0" class="no-results">
            <div class="no-results-icon">
              <i class="fas fa-search"></i>
            </div>
            <h3>Sin resultados</h3>
            <p>No se encontraron compras que coincidan con los filtros</p>
          </div>

          <div *ngIf="historialCompras.length === 0" class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-receipt"></i>
            </div>
            <h3>Sin historial</h3>
            <p>Aún no hay compras registradas</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
